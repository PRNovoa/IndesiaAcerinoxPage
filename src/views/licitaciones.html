<template id="view-licitaciones">
  <div class="min-h-screen bg-gray-50">
    <!-- Acerinox Header -->
    <header class="bg-white border-b border-gray-200 py-6">
      <div class="container mx-auto px-6 max-w-4xl">
        <img src="./src/e6d2977a0f97fa6399023458adebf7f2c2484c6e.png" alt="Acerinox Logo" class="h-10 w-auto">
      </div>
    </header>

    <div class="container mx-auto px-6 py-8 max-w-4xl">
      <div class="mb-6">
        <button onclick="window.location.hash='#/filtros'" class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </button>
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-1">Licitaciones</h1>
            <p class="text-sm text-gray-600">
              <span id="tenders-count">8</span> licitaciones ordenadas por relevancia
            </p>
          </div>
          <button onclick="window.location.hash='#/filtros'" class="px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg flex items-center gap-2 transition-colors text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
            Filtros
          </button>
        </div>
      </div>

      <div class="space-y-4" id="tenders-list">
        <!-- Las tarjetas se cargarán dinámicamente -->
      </div>
    </div>
  </div>

  <script>
    // Cargar y renderizar licitaciones desde JSON
    (async function() {
      try {
        const response = await fetch('./src/LicitacionesJson/matching_resultados.json');
        const data = await response.json();
        const resultados = data.resultados;
        
        // Convertir a array y ordenar por score_potencial_inox descendente
        const licitaciones = Object.entries(resultados)
          .map(([id, lic]) => ({ id, ...lic }))
          .sort((a, b) => b.score_potencial_inox - a.score_potencial_inox);
        
        // Actualizar contador
        document.getElementById('tenders-count').textContent = licitaciones.length;
        
        // Renderizar tarjetas
        const tendersList = document.getElementById('tenders-list');
        tendersList.innerHTML = licitaciones.map(lic => {
          const score = Math.round(lic.score_potencial_inox * 100);
          const scoreFormatted = (lic.score_potencial_inox).toFixed(2);
          
          // Color según el rango: 0-30 rojo, 31-70 amarillo, 71-100 verde
          let scoreClass, barColor;
          if (score <= 30) {
            scoreClass = 'text-red-500';
            barColor = 'bg-red-500';
          } else if (score <= 70) {
            scoreClass = 'text-yellow-500';
            barColor = 'bg-yellow-500';
          } else {
            scoreClass = 'text-green-500';
            barColor = 'bg-green-500';
          }
          
          const nivel = lic.nivel_potencial_inox || 'bajo';
          
          // Capitalizar primera letra de strings - asegurarse que empiece con mayúscula
          const capitalize = (str) => {
            if (!str) return str;
            const trimmed = str.trim();
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1);
          };
          
          const titulo = capitalize(lic.titulo_licitacion);
          const descripcion = capitalize(lic.descripcion_resumida);
          const region = capitalize(lic.region || lic.pais || 'España');
          const sector = capitalize(lic.sector || 'Sector no especificado');
          
          // Crear una fecha ficticia para mostrar (puedes ajustar esto)
          const today = new Date();
          const daysOffset = Math.floor(Math.random() * 30) + 5;
          const fecha = new Date(today.getTime() + daysOffset * 24 * 60 * 60 * 1000);
          const fechaStr = fecha.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
          
          return `
            <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-sm transition-shadow cursor-pointer tender-card" data-tender-id="${lic.id}">
              <div class="flex items-start justify-between gap-6">
                <div class="flex-1 min-w-0">
                  <h3 class="text-lg font-semibold text-gray-900 mb-3 leading-tight">${titulo}</h3>
                  
                  <div class="flex flex-wrap items-center gap-x-5 gap-y-2 text-sm text-gray-500 mb-4">
                    <div class="flex items-center gap-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      <span>${fechaStr}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                      </svg>
                      <span>${sector}</span>
                    </div>
                    <div class="flex items-center gap-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                      </svg>
                      <span>${region}</span>
                    </div>
                  </div>
                  
                  <p class="text-sm text-gray-600 leading-relaxed">${descripcion}</p>
                </div>
                
                <div class="flex flex-col items-end gap-3 flex-shrink-0">
                  <div class="flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${scoreClass}">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span class="${scoreClass} font-semibold text-base">${scoreFormatted}</span>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-gray-500 mb-1.5">Relevancia</div>
                    <div class="w-28 bg-gray-200 rounded-full h-2">
                      <div class="${barColor} h-2 rounded-full" style="width: ${score}%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Añadir event listeners a las tarjetas
        document.querySelectorAll('.tender-card').forEach(card => {
          card.addEventListener('click', function() {
            const tenderId = this.getAttribute('data-tender-id');
            window.location.hash = '#/detalle-licitacion?id=' + tenderId;
          });
        });
        
      } catch (error) {
        console.error('Error cargando licitaciones:', error);
        document.getElementById('tenders-list').innerHTML = '<div class="text-center text-red-600 p-8">Error cargando licitaciones</div>';
      }
    })();
  </script>
</template>
